<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>AOP in JavaScript and TypeScript | 张先森的代码小屋</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="jsaop">
  
  
  
  
  <meta name="description" content="Write something about aop in JavaScript and TypeScript.">
<meta name="keywords" content="js,aop">
<meta property="og:type" content="article">
<meta property="og:title" content="AOP in JavaScript and TypeScript">
<meta property="og:url" content="https://nullcc.github.io/2018/10/28/AOP_in_JavaScript_and_TypeScript/index.html">
<meta property="og:site_name" content="张先森的代码小屋">
<meta property="og:description" content="Write something about aop in JavaScript and TypeScript.">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://nullcc.github.io/assets/images/post_imgs/koa_onion.png">
<meta property="og:updated_time" content="2022-04-15T03:41:13.013Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="AOP in JavaScript and TypeScript">
<meta name="twitter:description" content="Write something about aop in JavaScript and TypeScript.">
<meta name="twitter:image" content="https://nullcc.github.io/assets/images/post_imgs/koa_onion.png">
  
    <link rel="alternate" href="/atom.xml" title="张先森的代码小屋" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">

  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Oswald%3A300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css">
  <link rel="stylesheet" href="/css/fashion.css">
  <link rel="stylesheet" href="/css/glyphs.css">

</head>
</html>


  <body data-spy="scroll" data-target="#toc" data-offset="50">


  


<header id="allheader" class="site-header" role="banner" 
   >
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/" rel="home" >
                <img style="margin-bottom: 10px;"  width="124px" height="124px" alt="Hike News" src=" /css/images/logo.jpg">
              </a>
            
          </h1>
          
          
            <div class="site-description">明镜止水</div>
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>

            <div class="clearfix sf-menu">
              <ul id="main-nav" class="menu sf-js-enabled sf-arrows"  style="touch-action: pan-y;">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/">首页</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/archives">归档</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/categories">分类</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/tags">标签</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/about">关于</a> </li>
                    
              </ul>
            </div>
          </nav>

      </div>
  </div>
</header>


  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-AOP_in_JavaScript_and_TypeScript" style="width: 66%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      AOP in JavaScript and TypeScript
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/10/28/AOP_in_JavaScript_and_TypeScript/" class="article-date">
	  <time datetime="2018-10-27T16:00:00.000Z" itemprop="datePublished">十月 28, 2018</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/编程语言/">编程语言</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>Write something about aop in JavaScript and TypeScript.</p>
<a id="more"></a>
<h2 id="AOP-Overview"><a href="#AOP-Overview" class="headerlink" title="AOP Overview"></a>AOP Overview</h2><p>Aspect Oriented Programming (AOP), Chinese meaning is “面向切面编程”. We can separate parts of business logic with AOP to reduce coupling of them.</p>
<p>Let’s image a very common situation, beside execute necessary automated operations, we also need to do something like logging, save screenshot when we use selenium-webdriver to do web automated testing. It is obvious that these operations is not strongly related with business logic, but we sure need them. Now the situation is that we need these functions but we no hope to include these code explicitly in modeling stage. So we want a new way to reslove it.</p>
<p>For example, we want to recode time consuming and take a screenshot after every step in web automated testing. The simplest way is to put the code which record time consuming and take a screenshot in every step. But disadvantages of this approach is if we have many step, things will become uncontrollable. It’s impossible to maintain thousands of steps which there are lots of similar code in every step.</p>
<p>AOP makes it possible to resolve this problem elegantly.</p>
<h2 id="AOP-vs-OOP"><a href="#AOP-vs-OOP" class="headerlink" title="AOP vs OOP"></a>AOP vs OOP</h2><p>We are familiar with Object Oriented Programming (OOP). When we get a requirements, firstly we analyze the requirements and extract some domain models. Every domain model has its own attributes and methods. People using encapsulation, composition, inheritance, polymorphism and design patterns to building software and practice the thinking of OOP.</p>
<p>If you have experiences about building software with OOP you will find that OOP is to model static things. In other words, OOP is for nouns. For example, we have a <code>Employee</code> class with attributes <code>name</code>, <code>age</code>, <code>title</code> and <code>department</code>, with methods <code>work</code>, <code>takeABreak</code> and <code>loginAdminSystem</code>. Attributes describe characteristics of objects, and methods are the operations objects can execute. Base on these, we can write some OO code:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> Employee &#123;</span><br><span class="line">  <span class="keyword">private</span> name: <span class="built_in">string</span>;</span><br><span class="line">  <span class="keyword">private</span> age: <span class="built_in">number</span>;</span><br><span class="line">  <span class="keyword">private</span> title: <span class="built_in">string</span>;</span><br><span class="line">  <span class="keyword">private</span> department: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params">name: <span class="built_in">string</span>, age: <span class="built_in">number</span>, title: <span class="built_in">string</span>, department: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">    <span class="keyword">this</span>.age = age;</span><br><span class="line">    <span class="keyword">this</span>.title = title;</span><br><span class="line">    <span class="keyword">this</span>.department = department;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> work() &#123;</span><br><span class="line">    <span class="comment">// code for working...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> takeABreak() &#123;</span><br><span class="line">    <span class="comment">// code for taking a break...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> loginAdminSystem() &#123;</span><br><span class="line">    <span class="comment">// code for logining admin system, it's a sensitive operation</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> employee = <span class="keyword">new</span> Employee(<span class="string">'Bob'</span>, <span class="number">35</span>, <span class="string">'Software Development Engineer'</span>, <span class="string">'Devlopment'</span>);</span><br><span class="line">employee.work();</span><br><span class="line">employee.takeABreak();</span><br></pre></td></tr></table></figure>
<p>Above code is strong related with Employee class which form the business logic. There is no doubt that, OOP is very suitable for describing objects.</p>
<p>But sometime we may want some more “dynamic” things, such as we hope to logging while user is executing a sensitive operation. If we choose OOP implementation, we must modify the code of the sensitive operation <code>loginAdminSystem</code> to add logging code to it. Like this:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">public</span> loginAdminSystem() &#123;</span><br><span class="line">  <span class="comment">// added: code for logging some information</span></span><br><span class="line">  <span class="comment">// code for logining admin system</span></span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>It’s work of course, but no elegant. Actually it againsts OCP (open closed principle). Logging are not strongly correlated with the sensitive operation above. We had better do not to modify business logic to add logging feature. </p>
<p>But how to reslove it? We can try AOP. Simplely, we can expose two sections in specific operation: one before it and another after it, then weave in other functions dynamically in runtime. That is to say AOP is for verbs. Our code will become more elegant and extendable with the cooperation of OOP and AOP.</p>
<p>A simple example: function wrapping. Assume we have a function <code>op</code>, we want to logging something before and after it:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">let op = () =&gt; &#123;</span><br><span class="line">  console.log(&apos;executing op...&apos;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">let oriOp = op;</span><br><span class="line"></span><br><span class="line">op = () =&gt; &#123;</span><br><span class="line">  console.log(&apos;before op...&apos;);</span><br><span class="line">  oriOp();</span><br><span class="line">  console.log(&apos;after op...&apos;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This time we wrap the function instead of modifying it.</p>
<p>AOP code in project is more complex than code above. Basically we need some meta programming technique to support AOP. But the basic principle is similar with code above. It is worth mentioning that AOP is a programming concept, but not own by a specific programming language. Most of programming languages can be written in AOP way.</p>
<h2 id="Solution-1-Simple-Method-Hooks"><a href="#Solution-1-Simple-Method-Hooks" class="headerlink" title="Solution 1 - Simple Method Hooks"></a>Solution 1 - Simple Method Hooks</h2><p>Solution 1 use hooks (before/after action) to wrap original method to new method, we put the auxiliary functions in hooks.<br>See <a href="https://github.com/nullcc/ts-aop-example/blob/master/src/driver/methodHook/base.ts" target="_blank" rel="noopener">base driver</a> and <a href="https://github.com/nullcc/ts-aop-example/blob/master/src/driver/methodHook/methodHook.ts" target="_blank" rel="noopener">method hook driver</a>.</p>
<p>Issues: It’s difficult to handle relationship between before action and after action. For example, if we want to record time consuming of an action, the before action and after action will be:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// before action</span></span><br><span class="line"><span class="keyword">const</span> recordStartTime = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> start = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime();</span><br><span class="line">  <span class="keyword">return</span> start;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// after action</span></span><br><span class="line"><span class="keyword">const</span> recordEndTime = <span class="keyword">async</span> start =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> end = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime();</span><br><span class="line">  <span class="keyword">const</span> consume = end - start;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`time consume: <span class="subst">$&#123;consume&#125;</span>ms`</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>and <code>registerHooksForMethods</code>:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> registerHooksForMethods(</span><br><span class="line">    methods: <span class="built_in">string</span>[],</span><br><span class="line">    beforeAction: <span class="built_in">Function</span>,</span><br><span class="line">    afterAction: <span class="built_in">Function</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">const</span> self = <span class="keyword">this</span>;</span><br><span class="line">    methods.forEach(<span class="function"><span class="params">method</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> originalMethod = self[method]; <span class="comment">// original method reference</span></span><br><span class="line">      <span class="keyword">if</span> (originalMethod) &#123;</span><br><span class="line">        self[method] = <span class="keyword">async</span> (...args) =&gt; &#123; <span class="comment">// wrap original method</span></span><br><span class="line">          <span class="keyword">const</span> beforeActionRes = <span class="keyword">await</span> beforeAction();</span><br><span class="line">          <span class="keyword">const</span> methodRes = <span class="keyword">await</span> originalMethod.call(self, ...args);</span><br><span class="line">          <span class="keyword">await</span> afterAction(beforeActionRes, methodRes);</span><br><span class="line">          <span class="keyword">return</span> methodRes;</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>As you can see above, in <code>registerHooksForMethods</code> method, we have to get the return value of before action and pass it to after action which implementation is ugly and inflexible.</p>
<p>So, we give up this solution even it may work.</p>
<h2 id="Solution-2-Static-Onion-Model"><a href="#Solution-2-Static-Onion-Model" class="headerlink" title="Solution 2 - Static Onion Model"></a>Solution 2 - Static Onion Model</h2><p>Let’s look at an interesting model first: middleware onion model in <a href="https://koajs.com/" target="_blank" rel="noopener">Koa</a>:</p>
<p><img src="/assets/images/post_imgs/koa_onion.png" alt="Koa middileware onion model"></p>
<p>See <a href="https://github.com/nullcc/ts-aop-example/blob/master/src/driver/staticOnion/base.ts" target="_blank" rel="noopener">base driver</a> and <a href="https://github.com/nullcc/ts-aop-example/blob/master/src/driver/staticOnion/staticOnion.ts" target="_blank" rel="noopener">static onion driver</a>.</p>
<p>Static onion model is much better than method hook. It use onion model to reslove issues in method hook solution. We use a decorator to decorate methods:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// decorator</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> webDriverMethod = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">target, methodName: <span class="built_in">string</span>, descriptor: PropertyDescriptor</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> desc = &#123;</span><br><span class="line">      value: <span class="string">"webDriverMethod"</span>,</span><br><span class="line">      writable: <span class="literal">false</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(target[methodName], <span class="string">"__type__"</span>, desc);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// in BaseWebDriver class, a web driver method</span></span><br><span class="line"><span class="meta">@webDriverMethod</span>()</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">async</span> findElement(</span><br><span class="line">  by: By,</span><br><span class="line">  ec: <span class="built_in">Function</span> = until.elementLocated,</span><br><span class="line">  timeout: <span class="built_in">number</span> = <span class="number">3000</span></span><br><span class="line">) &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="keyword">this</span>.webDriver.wait(ec(by), timeout);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.webDriver.findElement(by);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Call <code>use</code> method to add a middleware:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> use(middleware) &#123;</span><br><span class="line">  <span class="keyword">const</span> webDriverMethods = <span class="keyword">this</span>.getWebDriverMethods();</span><br><span class="line">  <span class="keyword">const</span> self = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> method of webDriverMethods) &#123;</span><br><span class="line">    <span class="keyword">const</span> originalMethod = <span class="keyword">this</span>[method];</span><br><span class="line">    <span class="keyword">if</span> (originalMethod) &#123;</span><br><span class="line">      <span class="keyword">this</span>[method] = <span class="keyword">async</span> (...args) =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> result;</span><br><span class="line">        <span class="keyword">const</span> ctx = &#123;</span><br><span class="line">          methodName: method,</span><br><span class="line">          args</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">await</span> middleware(ctx, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">          result = <span class="keyword">await</span> originalMethod.call(self, ...args);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="comment">// check this: we must decorate new method every time when adding a middleware</span></span><br><span class="line">      <span class="keyword">this</span>.decorate(<span class="keyword">this</span>[method]); </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> decorate(method) &#123;</span><br><span class="line">  <span class="keyword">const</span> desc = &#123;</span><br><span class="line">    value: <span class="string">"webDriverMethod"</span>,</span><br><span class="line">    writable: <span class="literal">false</span></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(method, <span class="string">"__type__"</span>, desc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>But there is a little disadvantage: We must decorate new method every time when adding a middleware. In order to avoid this, we can wrap the method in runtime dynamically. Let’s move on to Solution 3.</p>
<h2 id="Solution-3-Dynamic-Onion-Model"><a href="#Solution-3-Dynamic-Onion-Model" class="headerlink" title="Solution 3 - Dynamic Onion Model"></a>Solution 3 - Dynamic Onion Model</h2><p>See <a href="https://github.com/nullcc/ts-aop-example/blob/master/src/driver/dynamicOnion/base.ts" target="_blank" rel="noopener">base driver</a> and <a href="https://github.com/nullcc/ts-aop-example/blob/master/src/driver/dynamicOnion/dynamicOnion.ts" target="_blank" rel="noopener">dynamic onion driver</a>.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> DynamicOnionWebDriver <span class="keyword">extends</span> BaseWebDriver &#123;</span><br><span class="line">  <span class="keyword">protected</span> webDriver: WebDriver;</span><br><span class="line">  <span class="keyword">private</span> middlewares = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params">webDriver</span>) &#123;</span><br><span class="line">    <span class="keyword">super</span>(webDriver);</span><br><span class="line">    <span class="keyword">const</span> methods = <span class="keyword">this</span>.getWebDriverMethods();</span><br><span class="line">    <span class="keyword">const</span> self = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> method of methods) &#123;</span><br><span class="line">      <span class="keyword">const</span> desc = &#123;</span><br><span class="line">        enumerable: <span class="literal">true</span>,</span><br><span class="line">        configurable: <span class="literal">true</span>,</span><br><span class="line">        <span class="keyword">get</span>() &#123;</span><br><span class="line">          <span class="keyword">if</span> (methods.includes(method) &amp;&amp; <span class="keyword">this</span>.compose) &#123;</span><br><span class="line">            <span class="keyword">const</span> ctx = &#123; <span class="comment">// put some information in ctx if necessary</span></span><br><span class="line">              methodName: method,</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">const</span> originFn = <span class="keyword">async</span> (...args) =&gt; &#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">this</span>.methodMap[method].call(self, ...args);</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">const</span> fn = <span class="keyword">this</span>.compose();</span><br><span class="line">            <span class="keyword">return</span> fn.bind(<span class="literal">null</span>, ctx, originFn.bind(self));</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">this</span>.methodMap[method].bind(<span class="keyword">this</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">set</span>(value) &#123;</span><br><span class="line">          <span class="keyword">this</span>[method] = value;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>, method, desc);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> use(middleware) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> middleware !== <span class="string">"function"</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">"Middleware must be a function!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.middlewares.push(middleware);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> compose() &#123;</span><br><span class="line">    <span class="keyword">const</span> middlewares = <span class="keyword">this</span>.middlewares;</span><br><span class="line">    <span class="keyword">const</span> self = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">async</span> (ctx, next, ...args) =&gt; &#123;</span><br><span class="line">      <span class="keyword">let</span> res;</span><br><span class="line">      <span class="keyword">const</span> dispatch = <span class="keyword">async</span> i =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> fn = middlewares[i];</span><br><span class="line">        <span class="keyword">if</span> (i === middlewares.length) &#123;</span><br><span class="line">          fn = next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!fn) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (i === middlewares.length) &#123;</span><br><span class="line">            res = <span class="keyword">await</span> <span class="built_in">Promise</span>.resolve(fn.call(self, ...args));</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(fn(ctx, dispatch.bind(<span class="literal">null</span>, i + <span class="number">1</span>)));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(err);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">await</span> dispatch(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">return</span> res;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Dynamic onion model is much complex than solution 1 and 2. We use <code>Object.defineProperty</code> to define our getter for every method which is taged by <code>webDriverMethod</code> decorator. The <code>compose</code> method is the key to organize all middlewares and the original method, method getter will call <code>compose</code> method when we want to get a method and finally return a wrapped method.</p>
<p>Dynamic onion model is a little difficult to understand but it is worthy to take your time to learn it.</p>
<p>BTW: method hook, static onion model and dynamic onion model these names is invented by myself, if you find a better way to describe them, please tell me.</p>
<h2 id="Example-Repo"><a href="#Example-Repo" class="headerlink" title="Example Repo"></a>Example Repo</h2><p><a href="https://github.com/nullcc/ts-aop-example" target="_blank" rel="noopener">ts-aop-example</a></p>
<h2 id="Run-tests"><a href="#Run-tests" class="headerlink" title="Run tests"></a>Run tests</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm test</span><br></pre></td></tr></table></figure>
<h2 id="More-Informations"><a href="#More-Informations" class="headerlink" title="More Informations"></a>More Informations</h2><ul>
<li><a href="https://www.zhihu.com/question/24863332" target="_blank" rel="noopener">什么是面向切面编程AOP</a></li>
<li><a href="https://koajs.com/" target="_blank" rel="noopener">Koa Web Framework</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty" target="_blank" rel="noopener">Object.defineProperty()</a></li>
</ul>

        <!-- <h3>看了文章如果觉得喜欢的话可以捐赠哦！支付宝二维码：</h3>
        <img src="/assets/images/post_imgs/code_alipay.png" width=300 height=300> -->
      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/编程语言/">编程语言</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aop/">aop</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/js/">js</a></li></ul>

      
        
	<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script src="/js/md5.min.js"></script>
<div id="gitalk-container"></div>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: '4010e28e5153ab82b468',
        clientSecret: '217df2318bd891ba87b82dae5d67d7ae77bc1f17',
        id: md5(location.href),
        repo: 'nullcc-blog-comments',
        owner: 'nullcc',
        admin: 'nullcc',
        distractionFreeMode: 'true'
    })
    gitalk.render('gitalk-container')
</script>


      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/11/04/深入理解Node.js异步编程/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          深入理解Node.js异步编程
        
      </div>
    </a>
  
  
    <a href="/2018/10/11/[译]深入理解Node.js的事件循环、定时器和process.nextTick/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">(译)深入理解Node.js的事件循环、定时器和process.nextTick</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    
      <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#AOP-Overview"><span class="nav-number">1.</span> <span class="nav-text">AOP Overview</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AOP-vs-OOP"><span class="nav-number">2.</span> <span class="nav-text">AOP vs OOP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Solution-1-Simple-Method-Hooks"><span class="nav-number">3.</span> <span class="nav-text">Solution 1 - Simple Method Hooks</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Solution-2-Static-Onion-Model"><span class="nav-number">4.</span> <span class="nav-text">Solution 2 - Static Onion Model</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Solution-3-Dynamic-Onion-Model"><span class="nav-number">5.</span> <span class="nav-text">Solution 3 - Dynamic Onion Model</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Example-Repo"><span class="nav-number">6.</span> <span class="nav-text">Example Repo</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Run-tests"><span class="nav-number">7.</span> <span class="nav-text">Run tests</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#More-Informations"><span class="nav-number">8.</span> <span class="nav-text">More Informations</span></a></li></ol>
    
    </div>
  </aside>

</section>
        
      </div>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2023 张先森的代码小屋 All Rights Reserved.
        
      </div>
      <div class="site-credit">
        Theme by <a href="https://github.com/iTimeTraveler/hexo-theme-hipaper" target="_blank">hipaper</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";


    <!-- headerblur min height -->
    
    
</script>
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>













  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>

  <!-- 百度统计 -->
  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?c3ffa09eef07ac510ef2ab126054b1cd";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
  </script>
    
</body>
</html>
